---
title: "Run experiment"
author: "Francis Durnin-Vermette"
date: "2023/2/10"
output:
  html_notebook:
    toc: true
    number_sections: true
    df_print: paged
bibliography: bib.bib
editor_options:
  chunk_output_type: inline
---
<!-- Setup chunk: -->
```{r include=FALSE}
library(ggplot2)
library(knitr)
library(dplyr)
library(geojson)
library(tibble)
library(purrr)
library(stringr)
library(here)
library(lubridate)
library(tidyr)
dir.create(tempdir()) # This fixes a bug if the temporary directory is not found
here::i_am("walkthrough_icbm.rmd")

source(here::here("r/combine_soc_depth_increments.r"))
source(here::here("r/process_site_data.r"))
source(here::here("r/icbm_calculate_re.r"))
source(here::here("r/icbm_run.r"))
source(here::here("r/read_climate_data.r"))
source(here::here("r/spinup.r"))
source(here::here("r/bayesian_gsa.r"))
source(here::here("r/bayesian_sir.r"))
source(here::here("r/bayesian_validation.r"))
source(here::here("r/bayesian_uncertainty.r"))
```

Assign experimental parameters:
```{r}
experiment_driver <- "location_name"
experiment_driver_values <- c("Ellerslie", "Harrow")
experiment_model <- "ipcct2"
experiment_time <- Sys.time() %>%
	format("%Y%m%dT%H%M%S")
```

Choose sample sizes for the analysis:
```{r}
calibration_sample_percentage <- 10
gsa_sample_size <- 100
sir_sample_size <- 4
sir_resample_size <- 3
```

Choose how the gsa informs parameter selection for the sir:
```{r}
sensitive_parameter_cutoff <- 0.05

sensitive_parameter_override <- FALSE
sensitive_parameter_override_params <- c("tmax", "topt")
```


Create folders needed for analysis:
```{r}
experiment_driver_sanitized <- gsub("[^A-Za-z0-9 ]","", experiment_driver)
experiment_driver_values_sanitized <- gsub("[^A-Za-z0-9 ]","",experiment_driver_values)

experiment_name <- paste0(c(experiment_driver_sanitized, experiment_driver_values_sanitized), collapse = "-")

experiment_folder <- paste0(experiment_name, "_", experiment_time, "_", "gsa", gsa_sample_size, "_", "sir", sir_sample_size, "-", sir_resample_size, "_", "cal", calibration_sample_percentage)
experiment_path <- here("results", experiment_model, experiment_folder)

dir.create(here(experiment_path))
dir.create(here(experiment_path, "inputs"))
dir.create(here(experiment_path, "gsa"))
dir.create(here(experiment_path, "sir"))
dir.create(here(experiment_path, "validation"))
dir.create(here(experiment_path, "uncertainty"))
```


# Get raw (unprocessed) input data

## Site data:
```{r}
# Read SLC polygon IDs
polyids_all <- readr::read_csv(here("data","climate_data","Documentation", "SLC_PCPTREGION.csv"))
# Read initial C DSM estimates
initialc_dsm <- readr::read_csv(here("data/lte_soc_30_cm_dsm_expid.csv")) %>%
	select(Exp_ID, initial_dsm = `Can_SOC30 (Mg ha-1)`) %>%
	unique
# Read site data and attach POLYIDs and initial C estimates
site_data_raw <- readr::read_csv(here("data","LTE_Master_beta_mar29_addedcolumns.csv"), guess_max = Inf) %>%
	left_join(polyids_all, by=c("latitude" = "Lat", "longitude" = "Long")) %>%
	left_join(initialc_dsm, by=c("Exp_ID"))

# Save to file
readr::write_csv(site_data_raw, file=here(experiment_path,"inputs", "site_data_raw.csv"))
```
# Process data

Site data:
```{r}
site_data_processed <- site_data_raw %>%
	process_site_data

# Save to file
readr::write_csv(site_data_processed, file=here(experiment_path,"inputs", "site_data_processed.csv"))
```


## Only select data associated with the driver:
```{r}
site_data_driver <- site_data_processed %>%
	filter(.data[[experiment_driver]] %in% experiment_driver_values)

# Save to file
site_data_driver %>%
	readr::write_csv(file=here(experiment_path,"inputs","site_data_driver.csv"))
```


## Split the data into calibration and evaluation sets:
```{r}
site_data_driver_n <- site_data_driver %>%
	group_by(TrtID, replication_number, block) %>%
	n_groups

calibration_sample_indices <- sample.int(site_data_driver_n, ceiling(site_data_driver_n * calibration_sample_percentage/100))
evaluation_sample_indices <- setdiff(1:site_data_driver_n, calibration_sample_indices)


calibration_data <- site_data_driver %>%
	group_by(TrtID, replication_number, block) %>%
	group_split %>%
	`[`(calibration_sample_indices)

evaluation_data <- site_data_driver %>%
	group_by(TrtID, replication_number, block) %>%
	group_split %>%
	`[`(evaluation_sample_indices)

# Save to file
calibration_data %>%
	bind_rows() %>%
	readr::write_csv(file=here(experiment_path,"inputs","site_data_calibration.csv"))
evaluation_data %>%
	bind_rows() %>%
	readr::write_csv(file=here(experiment_path,"inputs","site_data_evaluation.csv"))
```

## Get climate data:
```{r}
climate_data <- read_climate_data(climate_data_directory = here("data","climate_data","W9param_TablesCleaned"))

# Save to file
readr::write_csv(climate_data, file=here(experiment_path,"inputs","climate_data.csv"))
```

## Get parameter ranges used in sensitivity analysis and bayesian calibration:
```{r}
param_bounds <- read.csv(here("data","ipcct2_parameters_gsa.csv"), stringsAsFactors = FALSE)

# Save to file
readr::write_csv(param_bounds, file=here(experiment_path,"inputs","parameter_ranges.csv"))
```

## Run spinup:
```{r}
# Calibration
calibration_data_spinup <- calibration_data %>%
	map(~slice(., 1:10))

# Get initial C
initial_c_calibration_measured_tha <- calibration_data_spinup %>%
	map(~first(.$initial_soc_tha[1]))

# Run spinup
initial_c_calibration_spinup <- map2(.x = calibration_data_spinup,
																		 .y = initial_c_calibration_measured_tha,
																		 ~spinup(site_data = .x, 
																		 				climate_data = climate_data,
																		 				initial_c = .y,
																		 				model = "ipcct2"))

# Evaluation
evaluation_data_spinup <- evaluation_data %>%
	map(~slice(., 1:10))

# Get initial C
initial_c_evaluation_measured_tha <- evaluation_data %>%
	map(~first(.$initial_soc_tha[1]))

# Run spinup
initial_c_evaluation_spinup <- map2(.x = evaluation_data_spinup,
																		.y = initial_c_evaluation_measured_tha,
																		~spinup(site_data = .x, 
																						climate_data = climate_data,
																						initial_c = .y,
																						model = "ipcct2"))

```

# Sensitivity Analysis
```{r}
if(!sensitive_parameter_override) {
	# Sobol-Jansen'
	sensitivity_calibration_sj <- gsa(site_data = calibration_data,
																		climate_data = climate_data,
																		initial_c = initial_c_calibration_spinup,
																		parameter_bounds = param_bounds,
																		sample_size = gsa_sample_size,
																		method = "soboljansen")
	
	# Save to file
	sensitivity_calibration_sj %>%
		mutate(sensitive_parameter_cutoff = sensitive_parameter_cutoff) %>%
		mutate(driver = experiment_driver,
					 value = paste(experiment_driver_values, collapse=","),
					 gsa_sample_n = gsa_sample_size) %>%
		readr::write_csv(file=here(experiment_path,"gsa","sj.csv"))
	
	# Fast99
	sensitivity_calibration_f99 <- gsa(site_data = calibration_data,
																		 climate_data = climate_data,
																		 initial_c = initial_c_calibration_spinup,
																		 parameter_bounds = param_bounds,
																		 sample_size = gsa_sample_size,
																		 method = "fast99")
	
	# Save to file
	sensitivity_calibration_f99 %>%
		mutate(sensitive_parameter_cutoff = sensitive_parameter_cutoff) %>%
		mutate(driver = experiment_driver,
					 value = paste(experiment_driver_values, collapse=","),
					 gsa_sample_n = gsa_sample_size) %>%
		readr::write_csv(file=here(experiment_path,"gsa","f99.csv"))
	
	# Get sensitive parameters from gsa results
	sensitive_parameters_sj <- sensitivity_calibration_sj %>%
		filter(totsi >= sensitive_parameter_cutoff) %>%
		pull(params)
	
	sensitive_parameters_f99 <- sensitivity_calibration_f99 %>%
		filter(main >= sensitive_parameter_cutoff) %>%
		pull(params)
	
	sensitive_parameters_both <- c(sensitive_parameters_sj, sensitive_parameters_f99) %>%
		unique
} else {
	sensitive_parameters_both <- sensitive_parameter_override_params
}
# Save list of sensitive parameters
sensitive_parameters_both %>%
	as.data.frame() %>%
	readr::write_csv(file=here(experiment_path,"gsa","sensitive_parameters.csv"))
```

## Graphing:
```{r}
if(!sensitive_parameter_override) {
	# Template
	sensitivity_graph_template <- ggplot(data=NULL) + 
		coord_flip() +
		theme_bw()
	
	# Sobol-Jansen
	# First-order sensitivity
	sensitivity_graph_first_sj <- sensitivity_graph_template %+% sensitivity_calibration_sj +
		aes(x = reorder(params, singsi),
				y = singsi,
				ymax=singsi_uci,
				ymin=singsi_lci) +
		geom_bar(stat='identity', fill="grey", alpha=0.70 ) +
		geom_errorbar(width=0.2, linewidth=1, aes(color="confidence_intervals")) +
		geom_hline(aes(color="cutoff", yintercept = sensitive_parameter_cutoff)) +
		scale_color_manual(values=c('confidence_intervals'='black', 'cutoff'='red')) +
		ylab("First-Order Sensitivity Index") +
		xlab("Parameters")
	
	
	# Total order sensitivity
	sensitivity_graph_total_sj <- sensitivity_graph_template %+% sensitivity_calibration_sj +
		aes(x = reorder(params, totsi),
				y = totsi,
				ymax=totsi_uci,
				ymin=totsi_lci) +
		geom_bar(stat='identity', fill="grey", alpha=0.70 ) +
		geom_errorbar(width=0.2, linewidth=1, aes(color="confidence_intervals")) +
		geom_hline(aes(color="cutoff", yintercept = sensitive_parameter_cutoff)) +
		scale_color_manual(values=c('confidence_intervals'='black', 'cutoff'='red')) +
		ylab("Total-Order Sensitivity Index") +
		xlab("Parameters")
	
	# Both
	sensitivity_calibration_sj_pivoted <- sensitivity_calibration_sj%>%
		pivot_longer(c("totsi", "singsi"), names_to = "order", values_to = "index")
	
	sensitivity_graph_both_sj <-  sensitivity_graph_template %+% sensitivity_calibration_sj_pivoted +
		aes(x = reorder(params, index),
				y = index,
				fill=order) +
		geom_bar(stat='identity', position="dodge", alpha=0.7) +
		geom_hline(aes(color="cutoff", yintercept = sensitive_parameter_cutoff)) +
		geom_errorbar(aes(ymax=singsi_uci, ymin=singsi_lci, color="confidence_intervals_single"), width=0.2, linewidth=1) +
		geom_errorbar(aes(ymax=totsi_uci, ymin=totsi_lci, color="confidence_intervals_total"), width=0.2, linewidth=1) +
		scale_color_manual(values=c('confidence_intervals_total'='black', 'confidence_intervals_single'='grey', 'cutoff'='red')) +
		ylab("Sensitivity Index") +
		xlab("Parameters")
	
	# Fast99
	# Main
	sensitivity_graph_main_f99 <- sensitivity_graph_template %+% sensitivity_calibration_f99 +
		aes(x = reorder(params, main),
				y = main) + 
		xlab("Parameters") +
		ylab("Main Effect Sensitivity Index") +
		geom_bar(stat='identity', fill="grey", alpha=0.70) +
		geom_hline(aes(color="cutoff", yintercept = sensitive_parameter_cutoff)) +
		scale_color_manual(values=c('confidence_intervals'='black', 'cutoff'='red'))
	
	# Interactions
	sensitivity_graph_interaction_f99 <- sensitivity_graph_template %+% sensitivity_calibration_f99 +
		aes(x = reorder(params, interactions),
				y = interactions) + 
		xlab("Parameters") +
		ylab("Interaction Effect Sensitivity Index") +
		geom_bar(stat='identity', fill="grey", alpha=0.70) +
		geom_hline(aes(color="cutoff", yintercept = sensitive_parameter_cutoff)) +
		scale_color_manual(values=c('confidence_intervals'='black', 'cutoff'='red'))
	# Both
	sensitivity_calibration_f99_pivoted <- sensitivity_calibration_f99 %>%
		pivot_longer(c("main", "interactions"), names_to = "order", values_to = "index")
	
	sensitivity_graph_both_f99 <-  sensitivity_graph_template %+% sensitivity_calibration_f99_pivoted +
		aes(x = reorder(params, index),
				y = index) +
		geom_bar(aes(fill = order), stat='identity', position="dodge", alpha=0.7) +
		geom_hline(aes(color="cutoff", yintercept = sensitive_parameter_cutoff)) +
		scale_color_manual(values=c('confidence_intervals'='black', 'cutoff'='red')) +
		ylab("Sensitivity Index") +
		xlab("Parameters")
	
	# Save to file
	ggsave(plot = sensitivity_graph_first_sj, filename = here(experiment_path,"gsa","sj_first.png"))
	ggsave(plot = sensitivity_graph_total_sj, filename = here(experiment_path,"gsa","sj_total.png"))
	ggsave(plot = sensitivity_graph_both_sj, filename = here(experiment_path,"gsa","sj_both.png"))
	
	ggsave(plot = sensitivity_graph_main_f99, filename = here(experiment_path,"gsa","f99_main.png"))
	ggsave(plot = sensitivity_graph_interaction_f99, filename = here(experiment_path,"gsa","f99_interaction.png"))
	ggsave(plot = sensitivity_graph_both_f99, filename = here(experiment_path,"gsa","f99_both.png"))
}
```

# Sampling Importance Resampling (SIR)
```{r}
# Only perform sir on sensititve parameters
param_bounds_sensitive <- param_bounds %>%
	filter(Parameter %in% sensitive_parameters_both)

sir_calibration <- sir(site_data = calibration_data,
											 climate_data = climate_data,
											 initial_c = initial_c_calibration_spinup,
											 parameter_bounds = param_bounds_sensitive,
											 sample_size = sir_sample_size,
											 resample_size = sir_resample_size)

readr::write_csv(sir_calibration$prior, file=here(experiment_path, "sir", "prior.csv"))
readr::write_csv(sir_calibration$posterior, file=here(experiment_path, "sir", "posterior.csv"))

# Find maximum a posteriori (MAP)
get_map <- function(x) {
	dens <- x %>%
		density
	return(dens$x[which.max(dens$y)])
}

sir_table <- sir_calibration$posterior %>%
	pivot_longer(cols = !SampleID) %>%
	group_by(parameter = name) %>%
	summarise(`2.5%` = quantile(value, probs = 0.025),
						`25%` = quantile(value, probs = 0.25),
						median = quantile(value, probs = 0.50),
						`75%` = quantile(value, probs = 0.75),
						`97.5%` = quantile(value, probs = 0.975),
						map = get_map(value),
						mean = mean(value))

sir_table %>%
	mutate(driver = experiment_driver,
				 value = paste(experiment_driver_values, collapse=","),
				 sir_sample_n = sir_sample_size,
				 sir_resample_n = sir_resample_size) %>%
	readr::write_csv(file= here(experiment_path,"sir","summary.csv"))
```

## Graphing:
```{r}
prior <- sir_calibration$prior %>%
	pivot_longer(cols = !`SampleID`)
posterior <- sir_calibration$posterior %>%
	pivot_longer(cols = !`SampleID`)

sir_graph <- ggplot() +
	geom_density(data = posterior, aes(value), col = NA, fill = "red", alpha = 0.2) +
	geom_density(data = prior, aes(value), col = NA, fill = "blue", alpha = 0.2) +
	facet_wrap(~name, scales = "free", ncol = 3) +
	theme_bw() +
	theme(panel.border = element_rect(colour = "black", fill = NA), panel.grid.major = element_blank(),
				axis.title.x=element_blank(),panel.grid.minor = element_blank()) +
	scale_y_continuous(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) +
	theme(aspect.ratio=1)

ggsave(plot = sir_graph, filename = here(experiment_path,"sir","sir.png"))
```

# Validation

## Make model returns for evaluation data set
```{r}
modelled_evaluation_prior <- run_loglike_parallel(site_data = evaluation_data,
																									climate_data = climate_data,
																									initial_c = initial_c_evaluation_spinup,
																									parameter_sample = sir_calibration$prior) %>%
	`[[`("model_return")

modelled_evaluation_posterior <- run_loglike_parallel(site_data = evaluation_data,
																											climate_data = climate_data,
																											initial_c = initial_c_evaluation_spinup,
																											parameter_sample = sir_calibration$posterior) %>%
	`[[`("model_return")
```

## Save model runs for each data set
```{r}
# Evaluation
modelled_evaluation_prior %>%
	bind_rows %>%
	readr::write_csv(file=here(experiment_path, "validation", "modelled_evaluation_prior.csv"))
modelled_evaluation_posterior %>%
	bind_rows %>%
	readr::write_csv(file=here(experiment_path, "validation", "modelled_evaluation_prior.csv"))

# Calibration
sir_calibration$model_return_prior %>%
	bind_rows %>%
	readr::write_csv(file=here(experiment_path, "validation", "modelled_calibration_prior.csv"))
sir_calibration$model_return_posterior %>%
	bind_rows %>%
	readr::write_csv(file=here(experiment_path, "validation", "modelled_calibration_posterior.csv"))
```


## Graphing SOC and ΔSOC
```{r}
# Generic function for building graphs
make_soc_graphs <- function(model_return_data) 
{
	soc_graph <- ggplot(model_return_data, aes(x = year)) +
		geom_col(aes(y = soc_tha_30cm), color="#888888", position=position_identity()) +
		geom_point(aes(y = soc_total_tha)) +
		facet_wrap(vars(TrtID)) +
		ylab("SOC (t/ha)") +
		theme_bw() +
		theme(aspect.ratio=1)
	
	soc_delta_cumulative_graph <- ggplot(model_return_data, aes(x = year)) +
		geom_col(aes(y = soc_tha_30cm_delta_cumulative), color="#888888", position=position_identity()) +
		geom_point(aes(y = soc_total_tha_delta_cumulative)) +
		facet_wrap(vars(TrtID)) +
		ylab("ΔSOC (t/ha)") +
		theme_bw() +
		theme(aspect.ratio=1)
	
	soc_delta_progressive_graph <- ggplot(model_return_data, aes(x = year)) +
		geom_col(aes(y = soc_tha_30cm_delta_progressive), color="#888888", position=position_identity()) +
		geom_point(aes(y = soc_total_tha_delta_progressive)) +
		facet_wrap(vars(TrtID)) +
		ylab("Year-by-year ΔSOC (t/ha)") +
		theme_bw() +
		theme(aspect.ratio=1)
	
	data_name <- deparse(substitute(model_return_data))
	
	ggsave(plot = soc_graph, filename = here(experiment_path,"validation",paste0(data_name,"_soc.png")))
	ggsave(plot = soc_delta_cumulative_graph, filename = here(experiment_path,"validation",paste0(data_name,"_soc_delta_cumulative.png")))
	ggsave(plot = soc_delta_progressive_graph, filename = here(experiment_path,"validation",paste0(data_name,"_soc_delta_progressive.png")))
	
	return(list(
		soc_graph = soc_graph,
		soc_delta_cumulative_graph = soc_delta_cumulative_graph,
		soc_delta_progressive_graph = soc_delta_progressive_graph
	))
}

```


```{r}
# Conduct validation on all data sets
validation_evaluation_prior <- modelled_evaluation_prior %>%
	purrr::map(validation)
validation_evaluation_posterior <- modelled_evaluation_posterior %>%
	purrr::map(validation)
validation_calibration_prior <- sir_calibration$model_return_prior %>%
	purrr::map(validation)
validation_calibration_posterior <- sir_calibration$model_return_posterior %>%
	purrr::map(validation)

# Get soc and delta soc values
stocks_evaluation_prior <- validation_evaluation_prior %>%
	purrr::map(~.[["stocks"]]) %>%
	bind_rows
stocks_evaluation_posterior <- validation_evaluation_posterior %>%
	purrr::map(~.[["stocks"]]) %>%
	bind_rows
stocks_calibration_prior <- validation_calibration_prior %>%
	purrr::map(~.[["stocks"]]) %>%
	bind_rows
stocks_calibration_posterior <- validation_calibration_posterior %>%
	purrr::map(~.[["stocks"]]) %>%
	bind_rows

# Make graphs
soc_graphs_evaluation_prior <- make_soc_graphs(stocks_evaluation_prior)
soc_graphs_evaluation_posterior <- make_soc_graphs(stocks_evaluation_posterior)
soc_graphs_calibration_prior <- make_soc_graphs(stocks_calibration_prior)
soc_graphs_calibration_posterior <- make_soc_graphs(stocks_calibration_posterior)
```

## Calculating Validation statistics
```{r}
validationstats_evaluation_prior <- validation_evaluation_prior %>%
	purrr::map(~.[["validation"]]) %>%
	bind_rows %>%
	mutate(distribution = "evaluation_prior",
				 driver = experiment_driver,
				 value = paste(experiment_driver_values, collapse=","),
				 gsa_sample_n = gsa_sample_size,
				 sir_sample_n = sir_sample_size,
				 sir_resample_n = sir_resample_size)

validationstats_evaluation_posterior <- validation_evaluation_posterior %>%
	purrr::map(~.[["validation"]]) %>%
	bind_rows %>%
	mutate(distribution = "evaluation_posterior",
				 driver = experiment_driver,
				 value = paste(experiment_driver_values, collapse=","),
				 gsa_sample_n = gsa_sample_size,
				 sir_sample_n = sir_sample_size,
				 sir_resample_n = sir_resample_size)

validationstats_calibration_prior <- validation_calibration_prior %>%
	purrr::map(~.[["validation"]]) %>%
	bind_rows %>%
	mutate(distribution = "calibration_prior",
				 driver = experiment_driver,
				 value = paste(experiment_driver_values, collapse=","),
				 gsa_sample_n = gsa_sample_size,
				 sir_sample_n = sir_sample_size,
				 sir_resample_n = sir_resample_size)

validationstats_calibration_posterior <- validation_calibration_posterior %>%
	purrr::map(~.[["validation"]]) %>%
	bind_rows %>%
	mutate(distribution = "calibration_posterior",
				 driver = experiment_driver,
				 value = paste(experiment_driver_values, collapse=","),
				 gsa_sample_n = gsa_sample_size,
				 sir_sample_n = sir_sample_size,
				 sir_resample_n = sir_resample_size)

# Save to file
readr::write_csv(validationstats_evaluation_prior, file = here(experiment_path,"validation","validation_evaluation_prior.csv"))
readr::write_csv(validationstats_evaluation_posterior, file = here(experiment_path,"validation","validation_evaluation_posterior.csv"))
readr::write_csv(validationstats_calibration_prior, file = here(experiment_path,"validation","validation_calibration_prior.csv"))
readr::write_csv(validationstats_calibration_posterior, file = here(experiment_path,"validation","validation_calibration_posterior.csv"))
```

## Graphing validation statistics
```{r}
# Evaluation
validation_evaluation <- bind_rows(validationstats_evaluation_prior, validationstats_evaluation_posterior)

validation_evaluation_violin_graph <- ggplot(validation_evaluation, aes(y=rmse_stocks, x=distribution)) +
	geom_violin() +
	theme_bw()
ggsave(plot = validation_evaluation_violin_graph, filename = here(experiment_path,"validation","validation_evaluation.png"))

# Calibration
validation_calibration <- bind_rows(validationstats_calibration_prior, validationstats_calibration_posterior)

validation_calibration_violin_graph <- ggplot(validation_calibration, aes(y=rmse_stocks, x=distribution)) +
	geom_violin() +
	theme_bw()
ggsave(plot = validation_calibration_violin_graph, filename = here(experiment_path,"validation","validation_calibration.png"))
```


# Uncertainty Analysis
```{r}
uncertainty_calibration_prior <- montecarlo(site_data = calibration_data,
																						climate_data = climate_data,
																						initial_c = initial_c_calibration_spinup,
																						distribution = sir_calibration$prior)
uncertainty_calibration_posterior <- montecarlo(site_data = calibration_data,
																								climate_data = climate_data,
																								initial_c = initial_c_calibration_spinup,
																								distribution = sir_calibration$posterior)

# Write to file
# Prior
readr::write_csv(uncertainty_calibration_prior$median, file=here(experiment_path,"uncertainty", "median_prior.csv"))
readr::write_csv(uncertainty_calibration_prior$montecarlo, file=here(experiment_path,"uncertainty", "montecarlo_prior.csv"))
# Posterior
readr::write_csv(uncertainty_calibration_posterior$median, file=here(experiment_path,"uncertainty", "median_posterior.csv"))
readr::write_csv(uncertainty_calibration_posterior$montecarlo, file=here(experiment_path,"uncertainty", "montecarlo_posterior.csv"))
```

## Graphing
```{r}
# 1:1 simulated:measured graph
uncertainty_graphdata1 <- uncertainty_calibration_prior$montecarlo %>%
	mutate(measure = "prior_montecarlo")
uncertainty_graphdata2 <- uncertainty_calibration_posterior$montecarlo %>%
	mutate(measure = "posterior_montecarlo")
uncertainty_graphdata3 <- uncertainty_calibration_posterior$median %>%
	mutate(measure = "posterior_median")
uncertainty_graphdata <- uncertainty_graphdata1 %>%
	bind_rows(uncertainty_graphdata2) %>%
	bind_rows(uncertainty_graphdata3)

uncertainty_graphdata_max <- max(c(max(uncertainty_graphdata$soc_tha_30cm, na.rm=T),
																	 max(uncertainty_graphdata$soc_total_tha, na.rm=T)))
uncertainty_graphdata_min <- min(c(min(uncertainty_graphdata$soc_tha_30cm, na.rm=T),
																	 min(uncertainty_graphdata$soc_total_tha, na.rm=T)))

uncertainty_graph <- ggplot(data = NULL, aes(x=soc_total_tha, y=soc_tha_30cm)) +
	geom_point(data=uncertainty_graphdata, aes(color = measure, shape = measure)) +
	scale_colour_manual(values = c("posterior_median" = "black",
																 "posterior_montecarlo" = "blue",
																 "prior_montecarlo" = "red")) +
	scale_shape_manual(values = c("posterior_median" = 16,
																"posterior_montecarlo" = 3,
																"prior_montecarlo" = 4)) +
	geom_abline(intercept = 0, slope = 1) +
	ylab("Measured SOC (t C / ha / 30cm)") +
	xlab("Simulated SOC (t C / ha / 30cm)") +
	lims(y = c(uncertainty_graphdata_min,uncertainty_graphdata_max),
			 x = c(uncertainty_graphdata_min,uncertainty_graphdata_max)) +
	coord_fixed(ratio = 1, expand = TRUE, clip="off") +
	theme_bw()

ggsave(plot = uncertainty_graph, filename = here(experiment_path,"uncertainty","uncertainty.png"))
```

```{r}
ribbon_points_posterior <- uncertainty_calibration_posterior$montecarlo %>%
	group_by(year, TrtID) %>%
	select(year, TrtID, soc_total_tha) %>%
	summarise(soc_total_max = max(soc_total_tha),
						soc_total_min = min(soc_total_tha))

ribbon_points_prior <- uncertainty_calibration_prior$montecarlo %>%
	group_by(year, TrtID) %>%
	select(year, TrtID, soc_total_tha) %>%
	summarise(soc_total_max = max(soc_total_tha),
						soc_total_min = min(soc_total_tha))

ribbon_graph <- ggplot(data = NULL, aes(x=year)) +
	geom_ribbon(data=ribbon_points_prior, aes(ymax=soc_total_max, ymin=soc_total_min, fill="prior"), alpha=0.3) +
	geom_ribbon(data=ribbon_points_posterior, aes(ymax=soc_total_max, ymin=soc_total_min, fill="posterior"), alpha=0.3) +
	geom_point(data=uncertainty_calibration_posterior$montecarlo, aes(y=soc_tha_30cm, color = "measured")) +
	geom_line(data=uncertainty_calibration_posterior$median, aes(y=soc_total_tha, color = "median")) +
	scale_color_manual(values = c("measured" = "black", "median" = "black"), limits = c("measured", "median")) +
	scale_fill_manual(values = c("prior" = "red", "posterior" = "blue"), limits = c("prior", "posterior")) +
	facet_wrap(vars(TrtID)) +
	theme_bw() +
	theme(aspect.ratio=1)

ggsave(plot = ribbon_graph, filename = here(experiment_path,"uncertainty","uncertainty_ribbon.png"))

```


Save the workspace image:
```{r}
save.image(file = here(experiment_path,"finished_workspace.RData"))
```



